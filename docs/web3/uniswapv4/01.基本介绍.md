## 一、Uniswap v4 是什么？（背景）

**Uniswap v4 并不是简单的 v3 升级版**，而是一次**架构级重构**：

-   v2：恒定乘积 AMM（简单、通用）
-   v3：集中流动性（效率极高，但复杂度暴增）
-   **v4：AMM 框架化（Protocol → Platform）**

👉 核心思想是：

**Uniswap 不再内置所有功能，而是提供一个高性能、可扩展的 AMM 内核，让开发者“插插件（Hooks）”来自定义行为。**

* * *

## 二、Uniswap v4 的核心特性

### 1️⃣ Hooks（最核心的创新）

#### 是什么？

Hooks 是**可插入到池生命周期中的外部合约逻辑**，可在以下关键节点执行自定义代码：

-   `beforeSwap / afterSwap`
-   `beforeAddLiquidity / afterAddLiquidity`
-   `beforeRemoveLiquidity / afterRemoveLiquidity`
-   `beforeInitialize`

你可以把它理解为：

**AMM 的“中间件 / 插件系统”**

#### 能做什么？

通过 Hooks，你可以实现：

-   动态手续费（根据波动率、交易方向）
-   限价单 / TWAMM（时间加权订单）
-   链上做市策略
-   LP 激励 / 手续费分成
-   MEV 防护逻辑
-   与外部协议联动（借贷、期权、收益聚合）

#### 解决了什么问题？

| 旧版本问题       | Hooks 的解决方式   |
| ----------- | ------------- |
| v3 功能写死在协议里 | 功能外包给 Hook 合约 |
| 新功能必须升级协议   | 无需改核心代码       |
| DeFi 创新碎片化  | 统一在 AMM 层完成   |

👉 **Uniswap v4 从“产品”变成“DeFi 基础设施平台”**

* * *

### 2️⃣ Singleton 合约（单合约架构）

#### 是什么？

v2 / v3：

-   每个 Pool = 一个独立合约

v4：

-   **所有 Pool 共用一个 Singleton 合约**
-   Pool 状态通过 `poolId` 映射存储

#### 解决了什么问题？

| 问题         | v4 改进   |
| ---------- | ------- |
| Pool 部署成本高 | 不再部署新合约 |
| 跨池交互昂贵     | 同一合约内操作 |
| Gas 利用率低   | 状态集中、复用 |

👉 **Gas 成本显著下降（尤其多跳 Swap、复杂策略）**

* * *

### 3️⃣ Flash Accounting（闪电记账）

#### 是什么？

v4 在一次交易（Transaction）中：

-   不立即做 Token 转账
-   只在内存中做**净额记账**
-   在交易结束时一次性结算

#### 类比理解：

像是「公司月末统一结算，而不是每笔都银行转账」

#### 解决了什么问题？

| 旧问题                 | 新方案    |
| ------------------- | ------ |
| 每一步都 ERC20 transfer | 最后统一结算 |
| transfer 极其耗 Gas    | 内存账本   |
| 多 Hook / 多池交互成本高    | 聚合成本   |

👉 **这是 v4 能承载复杂 Hooks 的底层基础**

* * *

### 4️⃣ 原生支持 ETH（无需 WETH）

#### 是什么？

v4 **直接支持原生 ETH**，不需要 WETH 包装。

#### 解决了什么问题？

-   减少一次 `wrap / unwrap`
-   降低 Gas
-   降低用户理解成本
-   Hook 可直接处理 ETH（如手续费燃烧）

* * *

### 5️⃣ 自定义手续费 & 手续费逻辑外包

#### v3 的限制

-   手续费是固定档位（0.05%、0.3%、1%）
-   只能在池初始化时选择

#### v4 的改变

-   手续费可以：

<!---->

-   -   动态计算
    -   按用户、方向、时间变化
    -   完全由 Hook 控制

#### 解决了什么问题？

-   高波动 ≠ 低波动资产，却用同一费率
-   LP 收益无法适配市场状态
-   做市策略无法链上表达

* * *

### 6️⃣ 更强的可组合性（DeFi 原语升级）

Hooks + Singleton + Flash Accounting 让：

-   Swap = 可编程行为
-   LP = 可定制金融产品
-   Pool = 策略容器

你甚至可以构建：
`
-   AMM + 借贷联动池
-   自动对冲池
-   LST / LSD 专用池
-   期权 / 永续模拟池

* * *

## 三、Uniswap v4 解决的“本质问题”

### 问题 1：AMM 功能创新太慢

v4：**协议稳定，功能外包**

* * *

### 问题 2：Gas 成本制约复杂策略

v4：**Singleton + Flash Accounting**

* * *

### 问题 3：LP 策略无法链上表达

v4：**Hooks = 策略执行器**

* * *

### 问题 4：DeFi 组合复杂、碎片化

v4：**统一在 AMM 层完成组合**

* * *

## 四、一句话总结

**Uniswap v4 不再是一个“交易所协议”，而是一个“可编程流动性操作系统”。**

如果你愿意，下一步我可以帮你：

-   用 **v3 vs v4 对比表**再深入一层
-   讲 **Hooks 的安全模型 & 风险点**
-   从 **开发者视角写一个 Hook 示例（伪代码）**