# Uniswap v4 基本介绍

## 什么是 Uniswap v4

Uniswap v4 是 Uniswap 协议的第四个主要版本，于 2023 年发布。作为去中心化交易所（DEX）的领军者，Uniswap v4 引入了一系列重大创新，旨在提高资本效率、降低交易成本并增强可扩展性。

## 核心特性

### 1. Hooks 机制
Uniswap v4 最重要的创新是引入了 Hooks 机制。Hooks 允许开发者在池子生命周期的关键点插入自定义逻辑：

- **beforeInitialize**: 池子初始化前
- **afterInitialize**: 池子初始化后  
- **beforeModifyPosition**: 修改头寸前
- **afterModifyPosition**: 修改头寸后
- **beforeSwap**: 交易前
- **afterSwap**: 交易后
- **beforeDonate**: 捐赠前
- **afterDonate**: 捐赠后

这使得开发者可以创建自定义的 AMM 逻辑，如动态手续费、链上限价单、时间加权平均等。

### 2. 单例架构
与 v3 中每个池子都是独立合约不同，v4 采用单例架构：

- 所有池子都存在于一个智能合约中
- 大幅降低了合约部署成本
- 提高了资本效率，允许不同池子之间的资产共享

### 3. Flash Accounting
引入了闪会计系统：

- 交易过程中不需要实际转移代币
- 只在交易结束时进行净额结算
- 减少了 gas 消耗和交易延迟

### 4. 原生 ETH 支持
v4 原生支持 ETH，不再需要 WETH 包装：

- 直接处理 ETH 交易
- 减少包装/解包装的成本和复杂性
- 提升用户体验

### 5. 更灵活的费用结构
- 支持动态手续费
- 可以通过 Hooks 实现复杂的费用模型
- LP 可以获得更灵活的收益分配

## 与前版本的对比

| 特性 | v2 | v3 | v4 |
|------|----|----|----|
| 流动性模型 | 恒定乘积 | 集中流动性 | 集中流动性 + Hooks |
| 合约架构 | 多合约 | 多合约 | 单例 |
| 费用结构 | 固定 | 阶梯式 | 动态可定制 |
| ETH 支持 | 需要 WETH | 需要 WETH | 原生支持 |
| 可扩展性 | 有限 | 有限 | 高度可扩展 |

## 使用场景

### 1. 高级交易策略
通过 Hooks 可以实现：
- 限价订单
- 止损订单
- 时间加权平均价格（TWAP）交易

### 2. 动态费用模型
- 基于波动性的动态手续费
- 基于交易量的折扣机制
- 套利保护机制

### 3. 跨池功能
- 多池套利
- 跨池流动性管理
- 组合交易策略

### 4. DeFi 集成
- 借贷协议集成
- 收益聚合器
- 治理代币机制

## 技术架构

### 核心合约
- **PoolManager**: 管理所有池子的单例合约
- **Hooks**: 可插拔的扩展模块
- **ProtocolFee**: 协议费用管理

### 安全特性
- 重入保护
- 滑点保护
- 紧急暂停机制

## 总结

Uniswap v4 代表了 DEX 技术的重大进步，通过 Hooks 机制和单例架构，为 DeFi 生态系统提供了前所未有的灵活性和效率。它不仅是一个交易协议，更是一个可编程的流动性基础设施，为未来 DeFi 创新奠定了坚实基础。

对于开发者和用户而言，v4 意味着：
- 更低的交易成本
- 更丰富的交易功能
- 更高的资本效率
- 更强的可扩展性

随着生态系统的不断发展，Uniswap v4 有望成为下一代 DeFi 应用的核心基础设施。